# 数据库学习笔记

## 第一章 分库分表

### 1.1 分库分表的各种方式

* 垂直分表

  > ​		可以把一个宽表的字段按访问频次，是否是大字段的原则拆分为多个表，这样既能使业务清晰，还能提升部分性能。拆分后，尽量从业务角度避免联查，否则性能方面将得不偿失

* 垂直分库

  > ​		可以把多个表按业务耦合松紧归类，分别存放在不同的库，这些库可以分布在不同服务器从而使访问压力被多服务器负载，大大提升性能，同时能提高整体架构的业务清晰度，不同的业务库可根据自身情况定制优化方案。但是它需要解决跨库带来的所有复杂问题

* 水平分库

  > ​		可以把一个表的数据（按数据行）分到多个不同的库，每个库只有这个表的部分数据，这些库可以分布在不同服务器，从而使访问压力被多服务器负载，大大提升性能。它不仅需要解决跨库带来的所有复杂问题，还要解决数据路由的问题

* 水平分表

  > ​		可以把一个表的数据（按数据行）分到多个同一个数据库的多张表，每个表只有这个表的部分数据，这样做能小幅提升性能，它仅仅作为水平分库的一个补充优化

* 一般来说，在系统设计阶段就应该根据业务耦合松紧来确定垂直分库，垂直分表方案，在数据量访问压力不是

  特别大的情况，首先考虑缓存、读写分离、索引技术等方案。若数据量极大，且持续增长，再考虑水平分库水

  平分表方案

### 1.2  分库分表带来的问题

#### 1.2.1  事务一致性问题

>  由于分库分表把数据分布在不同库甚至不同服务器，不可避免会带来分布式事务

#### 1.2.2  跨节点关联查询

>  关联查询改为分两次查询

#### 1.2.3  跨节点分页、排序

> ​		跨节点多库进行查询时，limit分页、order by排序等问题，就变得比较复杂了。需要先在不同的分片节点中将数据进行排序并返回，然后将不同分片返回的结果集进行汇总和再次排序

#### 1.2.4  主键避重

> ​		在分库分表环境中，由于表中数据同时存在不同数据库中，主键值平时使用的自增长将无用武之地，某个分区数据库生成的ID无法保证全局唯一性。因此需要单独设计全剧主键，以避免跨库主键重复问题

#### 1.2.5  公共表

> ​		实际的应用场景中，参数表、数据字典等都是数据量较少，变动少，而且属于高频联合查询的依赖表。例如字典表
>
> ​		可以将这类表在每个数据库都保存一份，所有对公共表的更新操作都同时发送到所有分库执行

## 第二章  ShardingJDBC

### 2.1  执行流程

通过日志分析，Sharding-JDBC在拿到用户要执行的sql后的执行流程

* 解析sql，获取片键值，在本例中使order_id

* Sharding-JDBC通过规则配置t_order_$->{order_id % 2}，知道了当order\_id为偶数时，应该往t_order_2表插

  入数据，为奇数时，往t_order_1插数据

* 于是Sharding-JDBC根据order_id的值改写sql语句，改写后的SQL语句是真实所要执行的SQL语句

* 执行改写后的真实sql语句

* 将所有真正执行sql的结果进行汇总合并，返回

### 2.2  基本概念

**逻辑表**

水平拆分的数据表的总称。例：订单数据表根据主键尾数拆分为10张表，分别是t_order_0到t_order_9，他们的逻辑表名为t_order

**真实表**

在分片的数据库中真实存在的物理表。即上个示例中的t_order_0到t_order_9

**数据节点**

数据分片的最小物理单元，由数据源名称和数据表组成。例：ds_0.t_order_0

**绑定表**

指分片规则一致的主表和子表。例：t_order表和t_order_item表，均按照order_id分片，绑定表之间的分区键完全相同，则此两张表互为绑定表关系。绑定表之间的多表关联查询不会出现笛卡尔关联，关联查询效率将大大提升

**广播表**

指所有的分片数据源中都存在的表，表结构和表中的数据在每个数据库中均完全一致。是用于数据量不大且需要与海量数据的表进行关联查询的场景。例：字典表

**分片键**

用于分片的数据库字段，是将数据库（表）水平拆分的关键字段。例：将订单表中的订单主键的尾数取模分片，则订单主键为分片字段。SQL中如果无分片字段，将执行全路由，性能较差。除了对单分片字段的支持，Sharding-Jdbc也支持根据多个字段进行分片

**分片算法**

通过分片算法将数据分片，支持通过=、BETWEEN和IN分片。分片算法需要应用方开发者自行实现，可实现的灵活度高。包括：精确分片算法、范围分片算法、复合分片算法等。例如：where order_id=？将采用精确分片算法，where order_id  in (?, ?, ?)将采用精确分片算法，where order_id BETWEEN ? and ?将采用范围分片算法，复合分片算法用于分片键有多个的复杂情况

**分片策略**

包含分片键和分片算法，由于分片算法的独立性，将其独立抽离。真正可用于分片操作的是分片键+分片算法，也就是分片策略。内置的分片策略大致可分为尾数取模、哈希、范围、标签、时间等。采用Groovy表达式

**自增主键生成策略**

通过在客户端生成自增主键替换以数据库原生自增主键的方式，做到分布式主键无重复

### 2.3  SQL解析

SQL解析 => SQL路由  => SQL改写  => SQL执行  => 结果归并